<?xml version="1.0"?>
<!--
  see /usr/share/snapwebsites/xsd/bundles.xsd for details
  to verify your changes (change the == with two dashes):
    xmllint ==noout ==schema /usr/share/snapwebsites/xsd/bundles.xsd /etc/snapwebsites/services.d/bundle-mailserver.xml
-->
<bundle>
  <name>mailserver</name>
  <description>
    <p>Install postfix and snapbounce to make this computer a mail server.</p>

    <p>The post installation script will then update the necessary setup
    files in order to get the duo working.</p>
  </description>
  <fields>
    <field name="domain" type="input">
      <label>Domain (myhostname)</label>
      <description>
        The name of the domain used for this mail server.
        For example: mail.snapwebsites.net -- your DNS should define that
        name as an MX record.
      </description>
    </field>
    <field name="organization" type="input">
      <label>Organization</label>
      <description>
        The name of your organization. It will be shown to people sending
        emails manually. It may be used by various systems to help contacting
        your organization. You may include a website URL although it is not
        that costumary to do so.
      </description>
    </field>
  </fields>
  <packages>snapbounce,postfix-policyd-spf-python,opendkim,opendkim-tools,opendmarc</packages>
  <postinst>
    if ! [ -f /etc/postfix/main.cf.orig ]
    then
      cp /etc/postfix/main.cf /etc/postfix/main.cf.orig
    fi
    if ! [ -f /etc/postfix/master.cf.orig ]
    then
      cp /etc/postfix/master.cf /etc/postfix/master.cf.orig
    fi
    if ! [ -f /etc/postfix/transport.maps.orig ]
    then
      cp /etc/postfix/transport.maps /etc/postfix/transport.maps.orig
    fi

    # Setup the transport.map file
    #
    # I'm not too sure why we would want these two lines:
    #
    #localhost bounces:
    #mail.$BUNDLE_INSTALLATION_DOMAIN bounces:
    #
    # For now, I removed them from the file altogether.
    #
    cat &gt;/etc/postfix/transport.maps &lt;&lt;EOF
# See SNAP-67
# After changes, run postmap:
#   postmap /etc/postfix/transport.maps
#
bounces@$BUNDLE_INSTALLATION_DOMAIN snapbounce:
EOF
    postmap /etc/postfix/transport.maps

    # setup the domain and a few other things
    # the few entries at the bottom connects snapbounce to postfix
    #
    MAILSERVER_SED=/tmp/bundle-mailserver.sed
    echo "s/^myhostname = .*/myhostname = $BUNDLE_INSTALLATION_DOMAIN/" &gt; ${MAILSERVER_SED}
    echo "s/^smtpd_banner = \\(.*\\) (.*)/smtpd_banner = \\1 ($BUNDLE_INSTALLATION_ORGANIZATION)/" &gt;&gt; ${MAILSERVER_SED}
    echo "$ i \\" &gt;&gt; ${MAILSERVER_SED}
    echo "# `date` \\" &gt;&gt; ${MAILSERVER_SED}
    echo "# Tell postfix how we want to handle bounced emails (SNAP-67) \\" &gt;&gt; ${MAILSERVER_SED}
    echo "notify_classes = bounce \\" &gt;&gt; ${MAILSERVER_SED}
    echo "bounce_notice_recipient = bounces@$BUNDLE_INSTALLATION_DOMAIN \\" &gt;&gt; ${MAILSERVER_SED}
    echo "transport_maps = hash:/etc/postfix/transport.maps" &gt;&gt; ${MAILSERVER_SED}
    sed -i.bak -f ${MAILSERVER_SED} /etc/postfix/main.cf

    # we then need to add a snapbounce entry to the master.cf file
    #
    MASTER=/etc/postfix/master.cf
    cp ${MASTER} ${MASTER}.bak
    echo "# Service to save bounced emails in Cassandra" &gt;&gt; ${MASTER}
    echo "snapbounce unix -       n       n       -       -       pipe" &gt;&gt; ${MASTER}
    echo "  flags=FRq user=snapwebsites argv=/usr/bin/snapbounce --sender ${sender} --recipient ${recipient}" &gt;&gt; ${MASTER}
    echo &gt;&gt; ${MASTER}

    # restart postfix with the correct parameters
    #
    # also the tripwire bundle may disable postfix so here we make sure
    # it is enabled
    #
    systemctl enable postfix
    systemctl restart postfix
  </postinst>
  <postrm>
    # Eliminate the postfix directory completely, that way we remove the .orig files.
    rm -rf /etc/postfix
  </postrm>
  <!-- TODO: add a postrm which at least removes the 3 variables we added
             at the end, because wihout snapbounce it won't work... -->
</bundle>
<!--
  vim: ts=2 sw=2 et
-->
