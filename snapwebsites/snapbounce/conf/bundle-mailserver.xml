<?xml version="1.0"?>
<!--
  see /usr/share/snapwebsites/xsd/bundles.xsd for details
  to verify your changes (change the == with two dashes):
    xmllint ==noout ==schema /usr/share/snapwebsites/xsd/bundles.xsd /etc/snapwebsites/services.d/bundle-mailserver.xml
-->
<bundle>
  <name>mailserver</name>
  <description>
    <p>Install postfix and snapbounce to make this computer a mail server.</p>

    <p>The post installation script will then update the necessary setup
    files in order to get the duo working.</p>
  </description>
  <fields>
    <field name="domain" type="input">
      <label>Domain (myhostname)</label>
      <description>
        The name of the domain used for this mail server.
        For example: mail.snapwebsites.net -- your DNS should define that
        name as an MX record.
      </description>
    </field>
    <field name="organization" type="input">
      <label>Organization</label>
      <description>
        The name of your organization. It will be shown to people sending
        emails manually. It may be used by various systems to help contacting
        your organization. You may include a website URL although it is not
        that costumary to do so.
      </description>
    </field>
  </fields>
  <packages>snapbounce,postfix,postfix-policyd-spf-python,opendkim,opendkim-tools,opendmarc</packages>
  <postinst>
    ################################################################################
    # Setup the transport.map file
    #
    # I'm not too sure why we would want these two lines:
    #
    #localhost bounces:
    #${BUNDLE_INSTALLATION_DOMAIN} bounces:
    #
    # For now, I removed them from the file altogether.
    #
    cat &gt;/etc/postfix/transport.maps &lt;&lt;EOF
# See SNAP-67
# After changes, run postmap:
#   postmap /etc/postfix/transport.maps
#
bounces@${BUNDLE_INSTALLATION_DOMAIN} snapbounce:
EOF
    postmap /etc/postfix/transport.maps

    echo "mail.${BUNDLE_INSTALLATION_DOMAIN}" &gt; /etc/mailname 

    # setup the domain and a few other things
    # the few entries at the bottom connects snapbounce to postfix
    #
    MAILSERVER_SED=/tmp/bundle-mailserver.sed
    echo "s/^myhostname = .*/myhostname = mail.${BUNDLE_INSTALLATION_DOMAIN}/"                       &gt;     ${MAILSERVER_SED}
    echo "s/^smtpd_banner = \\(.*\\) (.*)/smtpd_banner = \\1 (${BUNDLE_INSTALLATION_ORGANIZATION})/" &gt;&gt; ${MAILSERVER_SED}
    sed -i.bak -f ${MAILSERVER_SED} /etc/postfix/main.cf

    ################################################################################
    cat &gt;&gt; /etc/postfix/main.cf &lt;&lt;EOF

# `date`
# Tell postfix how we want to handle bounced emails (SNAP-67) 
#
notify_classes               = bounce
bounce_notice_recipient      = bounces@${BUNDLE_INSTALLATION_DOMAIN}
transport_maps               = hash:/etc/postfix/transport.maps
EOF

    ################################################################################
    # we then need to add a snapbounce entry to the master.cf file
    #
    MASTER=/etc/postfix/master.cf
    cat &gt;&gt; ${MASTER} &lt;&lt;EOF

# `date`
# Service to save bounced emails in Cassandra"                                                      
snapbounce unix -       n       n       -       -       pipe
  flags=FRq user=snapwebsites argv=/usr/bin/snapbounce --sender \${sender} --recipient \${recipient}
EOF

    ################################################################################
    # (re)start services with the correct parameters
    #
    # also the tripwire bundle may disable postfix so here we make sure
    # it is enabled
    #
    if systemctl is-active postfix
    then
      systemctl reload postfix
    else
      systemctl enable postfix
      systemctl start postfix
    endif
  </postinst>
  <postrm>
    rm -rf /etc/opendkim /etc/opendmarc
  </postrm>
</bundle>
<!--
  vim: ts=2 sw=2 et
-->
