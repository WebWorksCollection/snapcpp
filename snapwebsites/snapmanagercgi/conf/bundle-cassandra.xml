<?xml version="1.0"?>
<!--
  see /usr/share/snapwebsites/xsd/bundles.xsd for details
  to verify your changes (change the == with two dashes):
    xmllint ==noout ==schema /usr/share/snapwebsites/xsd/bundles.xsd /etc/snapwebsites/services.d/bundle-cassandra.xml
-->
<bundle>
  <name>cassandra</name>
  <description>
    <p>Install the Cassandra bundle and initializes it appropriately for your cluster.</p>
  </description>
  <fields>
    <field name="cluster_name" type="input">
      <label>Cluster Name</label>
      <description>Enter the name of your Cassandra cluster. <strong>All the nodes must have the same cluster name.</strong></description>
    </field>
    <field name="seeds" type="input">
      <label>Seeds</label>
      <description>Indicate Cassandra seed nodes IP addresses separated by commas.</description>
    </field>
    <field name="listen_address" type="input">
      <label>Listen Address</label>
      <description>Indicate the private IP address of this node (Try ifconfig and take the address for tun0 or eth0, make sure to use the secured IP address if you are using OpenVPN).</description>
    </field>
  </fields>
  <preinst>
    if test ! -f /etc/cassandra/cassandra.yaml
    then
      # Java on Launchpad from Oracle
      # (It is assumed that we will get Oracle installed and not any other
      # Java environment)
      apt-add-repository -y ppa:webupd8team/java
      echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | /usr/bin/debconf-set-selections

      # Cassandra from Apache2
      echo "# Info from http://docs.datastax.com/en/cassandra/3.x/cassandra/install/installDeb.html" > /etc/apt/sources.list.d/cassandra.list
      echo "#deb http://debian.datastax.com/datastax-ddc 3.5 main" >> /etc/apt/sources.list.d/cassandra.list
      echo "deb http://www.apache.org/dist/cassandra/debian 37x main" >> /etc/apt/sources.list.d/cassandra.list
      gpg --keyserver pgp.mit.edu --recv-keys F758CE318D77295D
      gpg --export --armor F758CE318D77295D | sudo apt-key add -
      gpg --keyserver pgp.mit.edu --recv-keys 2B5C1B00
      gpg --export --armor 2B5C1B00 | sudo apt-key add -
      gpg --keyserver pgp.mit.edu --recv-keys 0353B12C
      gpg --export --armor 0353B12C | sudo apt-key add -

      # After changing sources.list files we have to update the database
      # at least once
      apt-get update
    else
      touch /run/cassandra-already-installed
    fi
  </preinst>
  <packages>oracle-java8-installer, cassandra</packages>
  <postinst>
    if test ! -f /run/cassandra-already-installed
    then
      # cassandra auto-starts with the "wrong" parameters (arrrrhhh)
      #
      systemctl stop cassandra

      # Delete the "wrong" data because it won't restart with the change
      # of the cluster_name parameter below
      #
      rm -rf /var/lib/cassandra/*

      # setup the parameters in the cassandra.yaml file
      # The rcp_address and broadcast_rpc_address are bot set, which gives
      # you the ability to later change rcp_address to 0.0.0.0 without having
      # to worry about anything else.
      #
      # Also, remove all of the default encryption stuff since we are going to
      # overwrite all of this with the plugin.
      #
      perl -0777 -i.bak -p
        -e "s/^cluster_name: .*/cluster_name: '$BUNDLE_INSTALLATION_CLUSTER_NAME'/" \
        -e "s/- seeds: \".*\"/- seeds: \"$BUNDLE_INSTALLATION_SEEDS\"/" \
        -e "s/^listen_address: .*/listen_address: $BUNDLE_INSTALLATION_LISTEN_ADDRESS/" \
        -e "s/^rpc_address: .*/rpc_address: $BUNDLE_INSTALLATION_LISTEN_ADDRESS/" \
        -e "s/broadcast_rpc_address: .*/broadcast_rpc_address: $BUNDLE_INSTALLATION_LISTEN_ADDRESS/" \
        -e "s/^endpoint_snitch: .*/endpoint_snitch: GossipingPropertyFileSnitch/" \
        -e "s/^auto_snapshot: .*/auto_snapshot: false/" \
        -e "s/^server_encryption_options:\n.*internode_encryption:.*\n.*keystore:.*\n.*keystore_password:.*\n.*truststore:.*\n.*truststore_password:.*\n//"
        -e "s/^client_encryption_options:\n.*enabled:.*\n.*# If enabled.*\n.*optional:.*\n.*keystore:.*\n.*keystore_password:.*\n.*truststore:.*\n.*truststore_password:.*\n//"
              /etc/cassandra/cassandra.yaml
    fi

    ########################################################
    # From: https://datastax.github.io/cpp-driver/topics/security/ssl/
    #
    if ! [ -d /etc/cassandra/ssl ]
    then
      cat &gt;&gt; /etc/cassandra/cassandra.yaml &lt;&lt;EOF

########################################################
# `date`: added encryption options for client and server
#
server_encryption_options:
    internode_encryption: all
    keystore: /etc/cassandra/ssl/keystore.jks
    keystore_password: cassandra
    truststore: /etc/cassandra/ssl/truststore.jks
    truststore_password: cassandra
#
client_encryption_options:
    enabled: true
    optional: false
    keystore: /etc/cassandra/ssl/keystore.jks
    keystore_password: cassandra
    truststore: /etc/cassandra/ssl/truststore.jks
    truststore_password: cassandra
EOF

      mkdir -p /etc/cassandra/ssl/
      mkdir -p /var/lib/snapwebsites/cassandra-keys/
      cd /etc/cassandra/ssl

      keytool -noprompt -genkeypair -keyalg RSA \
        -alias node.${BUNDLE_INSTALLATION_LISTEN_ADDRESS} \
        -validity 36500 \
        -keystore keystore.jks \
        -storepass cassandra \
        -keypass cassandra \
        -dname "CN=${BUNDLE_INSTALLATION_LISTEN_ADDRESS}, OU=Cassandra Backend, O=Made To Order Software Corp, L=Orangevale, ST=California, C=US"

      keytool -export -alias node.${BUNDLE_INSTALLATION_LISTEN_ADDRESS} \
        -file node-${BUNDLE_INSTALLATION_LISTEN_ADDRESS}.cer \
        -keystore keystore.jks

      keytool -import -v -trustcacerts \
        -alias node.${BUNDLE_INSTALLATION_LISTEN_ADDRESS} \
        -file node-${BUNDLE_INSTALLATION_LISTEN_ADDRESS}.cer \
        -keystore truststore.jks

      keytool -exportcert -rfc -noprompt \
        -alias node.${BUNDLE_INSTALLATION_LISTEN_ADDRESS} \
        -keystore keystore.jks \
        -storepass cassandra \
        -file /var/lib/snapwebsites/cassandra-keys/${BUNDLE_INSTALLATION_LISTEN_ADDRESS}.pem
    fi

    # restart cassandra
    #
    systemctl start cassandra
  </postinst>
</bundle>
<!--
  vim: ts=2 sw=2 et
-->
