<?xml version="1.0"?>
<!--
  see /usr/share/snapwebsites/xsd/bundles.xsd for details
  to verify your changes (change the == with two dashes):
    xmllint ==noout ==schema /usr/share/snapwebsites/xsd/bundles.xsd /etc/snapwebsites/services.d/bundle-tools.xml
-->
<bundle>
  <name>dns</name>
  <description>
    <p>This bundle installs the Domain Name Server (bind9) on your machine.</p>
  </description>
  <fields>
    <field name="domain" type="input">
      <label>Domain (myhostname)</label>
      <description>
        The name of the domain used for this DNS server.
        For example: "snapwebsites.net"
      </description>
    </field>
    <field name="public_ip" type="input">
      <label>Public IP Address</label>
      <description>
        This is the public IP address to which the DNS will assign the "A" record.
      </description>
    </field>
  </fields>
  <packages>bind9</packages>
  <postinst>
    # Create backups if the .orig files don't exist.
    # But only do this once.
    #
    for i in \
       /etc/bind/named.conf.local
    do
      if [ -f $i.orig ]
      then
        # Reset the file to the original
        cp $i.orig $i
      else
        # Make a backup once
        cp $i $i.orig
      fi
    done

    ################################################################################
    # Set up the named.conf.local file
    #
    cat &gt;&gt; /etc/bind/named.conf.local &lt;&lt;EOF
zone "${BUNDLE_INSTALLATION_DOMAIN}" {
        type master;
        file "/etc/bind/${BUNDLE_INSTALLATION_DOMAIN}.zone";
};
EOF

    # TODO: make sure these values are sane
    #
    cat &gt;/etc/bind/${BUNDLE_INSTALLATION_DOMAIN}.zone &lt;&lt;EOF
\$ORIGIN .
\$TTL 86400
${BUNDLE_INSTALLATION_DOMAIN} IN SOA ns1.${BUNDLE_INSTALLATION_DOMAIN}. webmaster.${BUNDLE_INSTALLATION_DOMAIN}. (
          1
          3H
          180
          14D
          300
        )
        NS      ns1.${BUNDLE_INSTALLATION_DOMAIN}
        NS      ns2.${BUNDLE_INSTALLATION_DOMAIN}
        MX 10   mail.${BUNDLE_INSTALLATION_DOMAIN}

        A       ${BUNDLE_INSTALLATION_PUBLIC_IP}
\$ORIGIN ${BUNDLE_INSTALLATION_DOMAIN}.
w       A       ${BUNDLE_INSTALLATION_PUBLIC_IP}
ww      A       ${BUNDLE_INSTALLATION_PUBLIC_IP}
www     A       ${BUNDLE_INSTALLATION_PUBLIC_IP}
wwww    A       ${BUNDLE_INSTALLATION_PUBLIC_IP}
; vim: syntax=bindzone
EOF

    ################################################################################
    # (re)start service(s) with the correct parameters
    #
    # also the tripwire bundle may disable postfix so here we make sure
    # it is enabled
    #
    for i in bind9
    do
      systemctl enable  $i
      systemctl restart $i
    done
  </postinst>
  <postrm>
    # Restore the backups as the original files they were,
    # overwriting our changes
    for i in \
       /etc/bind/named.conf.local
    do
      if [ -f $i.orig ]
      then
        mv $i.orig $i 
      fi
    done
  </postrm>
</bundle>
<!--
  vim: ts=2 sw=2 et
-->
